<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulaire de Tâche</title>
    <link rel="stylesheet" href="3D_style.css">
    <script>
    // Variables JavaScript avec données JSON     
    let listePriorites = [
        { "idPriorite": 1, "priorite": "Importante" },
        { "idPriorite": 2, "priorite": "Moyenne" },
        { "idPriorite": 3, "priorite": "Peu importante" },
        { "idPriorite": 4, "priorite": "Optionnelle" }
    ];
    
    let listeStatuts = [
        { "idStatut": 1, "statut": "En attente" },
        { "idStatut": 2, "statut": "En cours" },
        { "idStatut": 3, "statut": "Urgent" },
        { "idStatut": 4, "statut": "Terminée" },
        { "idStatut": 5, "statut": "Annulée" }
    ];
    
    let listeCategories = [
        { "idCategorie": 1, "categorie": "Travail" },
        { "idCategorie": 2, "categorie": "Maison" },
        { "idCategorie": 3, "categorie": "Études" },
        { "idCategorie": 4, "categorie": "Loisirs" }
    ];
    
    let listeDifficultes = [
        { "idDifficulte": 1, "difficulte": "Facile" },
        { "idDifficulte": 2, "difficulte": "Moyenne" },
        { "idDifficulte": 3, "difficulte": "Difficile" }
    ];
    
    const STORAGE_KEY = "listeTaches";
    const ARCHIVED_STATUS_IDS = ["4", "5"]; // Terminée / Annulée

    function getLabelById(list, idKey, labelKey, searchedId) {
        const found = list.find(function(item) {
            return String(item[idKey]) === String(searchedId);
        });
        return found ? found[labelKey] : "(inconnu)";
    }

    console.log("=== DONNÉES TO-DO LIST ===");
    console.log("Priorités:", listePriorites);
    console.log("Statuts:", listeStatuts);
    console.log("Catégories:", listeCategories);
    console.log("Difficultes:", listeDifficultes);

    // LECTURE LOCALSTORAGE
    function loadListeTaches() {
        let listeTaches = [];
        let data = localStorage.getItem(STORAGE_KEY);

        console.log("localStorage brut :", data);

        if (data !== null) {
            listeTaches = JSON.parse(data);
        }

        return listeTaches;
    }

    // 3D-A — Boutons de statut
    function buildStatusButtonsHTML(idTache, currentIdStatut) {
        let html = "";

        listeStatuts.forEach(function(statut) {
            let isCurrent = (String(statut.idStatut) === String(currentIdStatut));

            html += `
                <button
                    type="button"
                    onclick="updateTaskStatus(${idTache}, ${statut.idStatut})"
                    class="status-btn ${isCurrent ? "current" : ""}"
                    ${isCurrent ? "disabled" : ""}
                >
                    ${statut.statut}
                </button>
            `;
        });

        return html;
    }

    // Construit un tableau HTML à partir d'une liste de tâches
    function creationTableau(liste, isArchived) {
        let html = `
        <table>
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Description</th>
                    <th>Date création</th>
                    <th>Date échéance</th>
                    <th>Localisation</th>
                    <th>Catégorie</th>
                    <th>Priorité</th>
                    <th>Difficulté</th>
                    <th>Statut</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
        `;

        liste.forEach(function(item) {
            let searchedIdCategorie= item.idCategorie;
            let foundCategorie= listeCategories.find(categorieItem => categorieItem.idCategorie==searchedIdCategorie).categorie;
            let searchedIdStatut= item.idStatut;
            let foundStatut= listeStatuts.find(statutItem => statutItem.idStatut==searchedIdStatut).statut;
            let searchedIdPriorite= item.idPriorite;
            let foundPriorite= listePriorites.find(prioriteItem => prioriteItem.idPriorite==searchedIdPriorite).priorite;
            let searchedIdDifficulte= item.idDifficulte;
            let foundDifficulte= listeDifficultes.find(difficulteItem => difficulteItem.idDifficulte==searchedIdDifficulte).difficulte;
            
            // Pas d’actions pour les tâches archivées
            let actionsHTML = isArchived ? "" : buildStatusButtonsHTML(item.idTache, item.idStatut);

            html += `
            <tr>
                <td>${item.libelle}</td>
                <td>${item.description}</td>
                <td>${item.dateCreation}</td>
                <td>${item.dateEcheance}</td>
                <td>${item.localisation}</td>
                <td>${foundCategorie}</td>
                <td>${foundPriorite}</td>
                <td>${foundDifficulte}</td>
                <td>${foundStatut}</td>
                <td>${actionsHTML}</td>
            </tr>
            `;
        });

        html += `
            </tbody>
        </table>
        `;

        return html;
    }

    // Afficher les tâches enregistrées
    function displayListeTaches(){
        let listeTaches = loadListeTaches();

        // Séparer tâches actives / archivées 
        let tachesActives   = listeTaches.filter(t => !ARCHIVED_STATUS_IDS.includes(String(t.idStatut))); 
        let tachesArchivees = listeTaches.filter(t =>  ARCHIVED_STATUS_IDS.includes(String(t.idStatut))); 

        const main = document.getElementById("main"); 
        main.innerHTML = ""; 

        // TABLEAU TÂCHES ACTIVES 
        main.insertAdjacentHTML(
            "beforeend",
            `<h2>Tâches à faire</h2>${creationTableau(tachesActives, false)}`
        ); 

        // TABLEAU TÂCHES ARCHIVÉES 
        main.insertAdjacentHTML(
            "beforeend",
            `<h2>Tâches archivées</h2>${creationTableau(tachesArchivees, true)}`
        ); 
    }

    // 3D-B / 3D-C — Mise à jour du Statut
    function updateTaskStatus(idTache, newIdStatut) {

        let listeTaches = loadListeTaches();

        let task = listeTaches.find(function(t) {
            return String(t.idTache) === String(idTache);
        });

        if (!task) {
            console.error("Tâche introuvable :", idTache);
            return;
        }

        task.idStatut = String(newIdStatut);

        localStorage.setItem(STORAGE_KEY, JSON.stringify(listeTaches));
        console.log("Statut mis à jour pour la tâche", idTache);

        displayListeTaches();
    }

    function retour(){
        location.href="3B.html";
    }

    // Permet d'exécuter la fonction uniquement lorsque tout le code est chargé
    document.onreadystatechange = function () {
        if (document.readyState === "complete"){
            displayListeTaches();
        }
    };
</script>
</head>
<body>
    <div>
        <header>
            <h1>✨ Ma To Do Liste ✨ </h1>
            <p class="subtitle">Organisez votre journée avec style</p>
        </header>

        <div id="main">
            
        </div>
        
        <button id="backButton" type="button" onclick="retour()">Créer une nouvelle tâche</button>

        <footer>
             <p>© 2025 SYNVA M2. Créé par Charlie DRANEBOIS, Daria KOROTAEVA, Islem OUESLATI et Oumaima SARIM</p>
        </footer>
    </div>
</body>
</html>
